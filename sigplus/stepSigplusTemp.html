<form id="1" class="formDefault" method="post" action="#">
<DIV id="Signatures" style=" margin:0px;" align="center">
<div class="borderForm" style="width:800px; padding-left:0; padding-right:0; border-width:1;">
<div class="boxTop"><div class="a"></div><div class="b"></div><div class="c"></div></div>
  <div class="content"  style="height:100%;" >
    <table width="99%" >
    <tr>
      <td valign='top'>
      <table cellspacing="0" cellpadding="0" border="0" width="100%" >

        <tr>
          <td colspan='2'>
            <table width="100%" cellspacing="0" cellpadding="0" id="stepsid">
            <tr>
              <td class="tableOption" width="120px" align="left">
               <img width="6" src="/images/bulletButton.gif"/>
               <a id="form[DYN_BACKWARD]" class="tableOption" onclick="" name="form[DYN_BACKWARD]" href="{previousStep}">{previousStepLabel}</a>
              </td>
              <td class="tableOption" width='400px'> </td>
              <td class="tableOption" width="120px" align="right">
               <img width="6" src="/images/bulletButton.gif"/>
               <a id="form[DYN_FORWARD]" class="tableOption" onclick="" name="form[DYN_FORWARD]" href="{nextStep}">{nextStepLabel}</a>
              </td>
            </tr>
          </table>
          </td>
        </tr>


        <tr>
          <td class="FormTitle" align="" colspan="2">
          <span >Sign document {docTitle}</span>
          </td>
        </tr>

        <tr>
          <td colspan="2">
            <table cellspacing="0" cellpadding="0" border="0" width="100%" id="divDocument" style="display:{divDisplayDocument};">
            <tr ><td class="FormContent" colspan='2' ><br></td></tr>
            <tr >
              <td class="FormContent" align="" width="20px">
                <span id='label1'></span>
              </td>
              <td>
              <input id='btnOpenSigned' type='button' value= 'Open signed document' onclick="openUnsigned();" width="90px">
              </td>
              <td class="FormContent"  >
                <input id='btnStartAgain' type='button' value= 'Sign again' onclick="startSigning();" width="80px">
                &nbsp;
              </td>
<!--
              <td class="FormContent"  >
                <input id='btnNextStep' type='button' value= 'Continue' onclick="window.location='{nextStep}';" width="80px">
                &nbsp;
              </td>
!-->
            </tr>
            </table>
          </td>
        </tr>

        <tr>
          <td colspan="2">
            <table cellspacing="0" cellpadding="0" border="0" width="100%" id="divSigners" style="display:{divDisplaySigners};">
<!-- START BLOCK : signers -->
  <!-- START BLOCK : startTR -->
        <tr>
  <!-- END BLOCK : startTR -->
          <td class='formField' style='text-align: center' >
            <img border='1' id='sign{sigid}' src='../sigplus/services/download?stpid={stpid}&sigid={sigid}&appid={appid}&tasid={tasid}' width='364' height='93'><br>
            {signer}
          </td>
  <!-- START BLOCK : endTR -->
        </tr>
  <!-- END BLOCK : endTR -->
<!-- END BLOCK : signers --> 

        <tr>
          <td class="FormContent" align="" colspan="2">
            <table cellspacing="0" cellpadding="0" border="0" width="100%" >
              <tr>
  <!-- START BLOCK : openUnsigned -->
          <td>
          <input id='btnOpen' type='button' value= 'Open unsigned document' onclick="openUnsigned();" width="90px">
          </td>
  <!-- END BLOCK : openUnsigned -->
  <!-- START BLOCK : openSigned -->
          <td>
          <input id='btnOpen' type='button' value= 'Open signed document' onclick="openUnsigned();" width="90px">
          </td>
  <!-- END BLOCK : openSigned -->
          <td>
          <input id='btnStart' type='button' value= 'Start signing' onclick="startSigning();" width="90px">
          </td>
          <td class="FormContent"  >
          <input id='btnCancel' type='button' value= 'Cancel' disabled=false onclick="cancelSigning();" width="90px">
          </td>
          <td class="FormContent"  >
          <input id='btnContinue' type='button' value= 'Continue' disabled onclick="continueGenerate( '{stepUidObj}', '{stpid}');" width="90px">
          </td>
           <td class="FormContent" align="" width="560px">
          	<span id='label' style="display:none;"></span>
          </td>
              </tr>
            </table>

          </td>
        </tr>

            </table>
          </td>
        </tr>
      </table>
      </td>
    </tr>
    <tr>
      <td class="FormContent" align="" colspan="2">
        <table cellspacing="0" cellpadding="0" border="0" width="100%">
          <tr>
          <td class="FormContent" align="" width="20px">
          	<span id='label1'></span>
          </td>
          </tr>
        </table>
      </td>
    </tr>
      </div>

      </td>
    </tr>
    </table>
    </div>
  <div class="boxBottom"><div class="a"></div><div class="b"></div><div class="c"></div></div>
 </div>
</DIV>


<script language="javascript">
	if(document.getElementById('btnOpen').value == 'Open unsigned document'){document.getElementById('stepsid').style.display = 'none';}else{document.getElementById('stepsid').style.display = 'block';}
  setTimeout ( checkSignatures, 2000 );
  var signArray;
  var oldArray = {sSignArray} ;
  var iSigners = {iSigners} ;

  function startSigning() {
  	document.getElementById('divDocument').style.display = 'none';
  	document.getElementById('divSigners').style.display = 'block';
    document.getElementById('btnStart').disabled = true;
    document.getElementById('btnCancel').disabled = false;
  	r = "<iframe width=200px height=18px src='{URL}' border='0' ></iframe>";
    document.getElementById('label').innerHTML = r;
  }
  
  function cancelSigning() {
    document.getElementById('btnStart').disabled = false;
    document.getElementById('btnCancel').disabled = true;
  	r = "<iframe width=200px height=18px src='{URLCancel}' border='0' ></iframe>";
    document.getElementById('label').innerHTML = r;
  }
  
  function openUnsigned() {
    window.open( '{urlShowDoc}', 'outputDocument' );
  }
  
  function checkSignatures ( ) {
    var oRPC = new leimnud.module.rpc.xmlhttp({
        url:  '../sigplus/ajax?stpid=' + '{stpid}' ,
        args: ''
      });
      oRPC.callback = function(oRPC) {
        r = oRPC.xmlhttp.responseText;
        signArray = eval ( "("+ r + ")");
        document.getElementById('label').innerHTML = r;

        iSigned = 0;
        for ( i = 0; i < 9 ; i++ ) {
          if ( signArray[i] > oldArray[i]  ) {
            image = document.getElementById('sign' + i);
            //image.src = image.src ;
            image.src = image.src + "&fmtime=" + signArray[i];
          }
          if ( signArray[i] > oldArray[i] ) {
            oldArray[i] = signArray[i];
          }
          if ( signArray[i] > 0 ) iSigned ++;
        }

        document.getElementById('btnContinue').disabled = true;
        if ( iSigned == iSigners ) {
          document.getElementById('btnStart').disabled = true;
          document.getElementById('btnCancel').disabled = true;
          document.getElementById('btnContinue').disabled = false;
        }
        else {
          setTimeout ( checkSignatures, 5000 );
        }
      }.extend(this);
      oRPC.make();

  }

  function continueGenerate(sigid, stepid) {
  	
    var oRPC = new leimnud.module.rpc.xmlhttp({
        url:  '../sigplus/sigplusGenerateHtmlPdf?sigid='  + sigid + '&stepid=' + stepid ,
        args: ''
      });
      oRPC.callback = function(oRPC) {
        r = oRPC.xmlhttp.responseText;
        //document.getElementById('divDocument').style.display = 'block';
        //document.getElementById('divSigners').style.display = 'none';
        //alert ( r );
        window.location = window.location;
      }.extend(this);
      oRPC.make();
  }
  

</script>

